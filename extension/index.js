var e=require("nodecg-io-core").requireService;function n(e,n,t){if(e.log.debug("actually doing join to ",t),t){let i=t;i.startsWith("#")||(i="#"+i),e.log.debug("doing it for real",t),n.join(i).then((()=>function(e,n){const t=e.Replicant("twitchChannel");function i(e){n.say(t.value,e)}e.log.info(`Connected to twitch channel "${t.value}"`),n.onMessage(((n,i,o,a)=>{const c=a.parseEmotes().map((e=>"emote"===e.type?{...e,displayInfo:e.displayInfo.getUrl({animationSettings:"default",backgroundType:"dark",size:"1.0"})}:{...e}));n.toLowerCase()===t.value.toLowerCase()&&e.sendMessage("ChatReceived",{user:i,message:o,msgobj:c},(e=>{e&&console.error(e)}))})),e.listenFor("SendChatMessage",i),e.listenFor("DisconnectTwitch",(()=>{e.Replicant("twitchConnected").value&&(e.log.info("Disconnecting twitch"),e.Replicant("twitchConnected").value=!1,e.unlisten("SendChatMessage",i),n.part(t.value))})),e.Replicant("twitchConnected").value=!0}(e,n))).catch((n=>{e.log.error(`Couldn't connect to twitch: ${n}.`);e.Replicant("twitchConnected").value=!1}))}}module.exports=function(t){t.Replicant("twitchChannel",{defaultValue:""}),t.Replicant("twitchConnected",{defaultValue:!1}),t.log.info("Twitch listener bundle starting.");const i=e(t,"twitch-chat");i.onAvailable((async e=>{!function(e,t){e.log.info("Setting up Twitch Chat service.");const i=e.Replicant("twitchChannel");i.value&&(e.log.info("Joining last channel ",i.value),n(e,t,i.value)),e.listenFor("ConnectTwitch",(()=>{!e.Replicant("twitchConnected").value&&i.value&&(e.log.info("Joining requested channel ",i.value),n(e,t,i.value))})),e.log.info("Done setting up Twitch Chat service.")}(t,e)})),i.onUnavailable((async()=>function(e){e.log.info("Tearing down Twitch Chat service."),e.Replicant("twitchConnected").value=!1,e.log.info("Done tearing down Twitch Chat service.")}(t))),t.log.info("Twitch listener bundle is running.")};
//# sourceMappingURL=index.js.map
